# UC-01.1: Nâng cấp xác thực và quản lý tài khoản - Kế hoạch triển khai chi tiết

## Tổng quan
Cải thiện hệ thống xác thực với email chuẩn hóa và bổ sung chức năng thay đổi mật khẩu.

## Các bước thực hiện

### 1. Chuẩn hóa email
- [X] Tạo migration để thêm cột `normalizedEmail` vào bảng `User`
- [X] Cập nhật hàm đăng ký để chuẩn hóa email và lưu vào `normalizedEmail`
- [X] Cập nhật hàm đăng nhập để sử dụng `normalizedEmail` khi tìm kiếm user
- [X] Thêm kiểm tra trùng lặp email dựa trên `normalizedEmail`

### 2. Cải tiến UI Dashboard Header
- [X] Tạo component `UserDropdown` với icon user và menu dropdown
- [X] Thêm các mục "Thay đổi mật khẩu" và "Đăng xuất" vào dropdown
- [X] Tích hợp `UserDropdown` vào `DashboardHeader`

### 3. Chức năng thay đổi mật khẩu
- [X] Tạo component `ChangePasswordModal`
- [X] Thêm form với các trường: mật khẩu cũ, mật khẩu mới, nhập lại mật khẩu mới
- [X] Implement logic mở/đóng modal
- [X] Tạo API endpoint `/api/auth/change-password`
- [X] Implement logic xử lý thay đổi mật khẩu ở phía server
- [X] Thêm validation cho form (client-side và server-side)
- [X] Hiển thị thông báo toast khi thay đổi mật khẩu thành công

### 4. Cập nhật tests và documentation
- [ ] Cập nhật unit tests cho các hàm auth đã được sửa đổi
- [ ] Thêm integration tests cho chức năng thay đổi mật khẩu
- [ ] Cập nhật tài liệu API cho endpoint mới

## Các file cần chỉnh sửa
1. `/migrations/YYYYMMDD_add_normalized_email.sql`
2. `/app/workers/lib/auth.ts`
3. `/app/components/dashboard/DashboardHeader.tsx`
4. `/app/components/dashboard/UserDropdown.tsx`
5. `/app/components/dashboard/ChangePasswordModal.tsx`
6. `/app/routes/dashboard.tsx`
7. `/workers/routes/auth.ts`
8. `/app/utils/validation.ts` (nếu cần)
9. `/tests/auth.test.ts` (nếu cần)
10. `/docs/01-gioi-thieu.md` (cập nhật file này để ghi lại các API endpoint)

## Lưu ý
- Đảm bảo tất cả các thay đổi đều có khả năng rollback
- Kiểm tra kỹ các vấn đề bảo mật, đặc biệt là trong quá trình thay đổi mật khẩu
- Đảm bảo UX mượt mà, có loading states và thông báo lỗi rõ ràng

## Tiêu chí nghiệm thu (AC)
- [ ] Email không phân biệt hoa thường khi đăng nhập/đăng ký
- [ ] Không thể tạo 2 tài khoản với email chỉ khác hoa thường
- [ ] Dropdown user menu hoạt động mượt mà
- [ ] Modal thay đổi mật khẩu hiển thị đúng, validation chính xác
- [ ] Thay đổi mật khẩu thành công, có thể đăng nhập với mật khẩu mới ngay lập tức
- [ ] Toast thông báo hiển thị khi thay đổi mật khẩu thành công
- [ ] Modal có thể đóng bằng ESC hoặc click outside
- [ ] Có loading state khi đang xử lý thay đổi mật khẩu
- [ ] Form reset sau khi thành công hoặc đóng modal